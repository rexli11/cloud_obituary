{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>製作新訃聞 - 楊子佛教禮儀雲端訃聞系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #385A52;
            padding: 20px;
            background-repeat: no-repeat;
            background-position: center top;
            background-size: contain;
        }
        
        .title-container {
            background-color: #385A52;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .btn-submit {
            width: 200px;
        }

        .preview-box {
            background-color: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
        }

        .preview-box h6 {
            margin-bottom: 10px;
            color: #4a76cf;
        }

        .preview-box img {
            width: 100% !important;
            height: 500px !important;
            object-fit: cover;
            object-position: top;
            border-radius: 5px;
        }

        .desktop-preview img,
        .mobile-preview img {
            width: 100% !important;
            height: 1000px !important;
            object-fit: cover;
            display: block;
        }

        @font-face {
            font-family: '標楷體';
            src: url('/static/fonts/kaiti.ttf') format('truetype');
        }
        
        @font-face {
            font-family: '華康仿宋體';
            src: url('/static/fonts/fangsong.ttf') format('truetype');
        }
        
        .preview-box {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .preview-text {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .background-preview {
            max-height: 300px;
            overflow-y: auto;
            text-align: center;
        }
        
        /* 添加 RWD 背景控制 */
        @media screen and (max-width: 600px) {
            body.has-background[data-desktop-bg] {
                background-image: var(--mobile-bg) !important;
            }
        }

        /* 添加儀式流程相關樣式 */
        .ceremony-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        
        .ceremony-item input[type="time"] {
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        .ceremony-item input[type="text"] {
            flex-grow: 1;
        }
        
        .btn-primary {
            background-color: #4a76cf;
            border-color: #4a76cf;
        }
        
        .btn-primary:hover {
            background-color: #3a66bf;
            border-color: #3a66bf;
        }
    </style>
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script> -->
</head>
<body>
    <div class="container">
        <div class="title-container">
            <h2>製作新訃聞</h2>
        </div>

        <div class="form-container">
            <form method="POST" action="{% url 'preview_obituary' %}" enctype="multipart/form-data" id="obituaryForm">
                {% csrf_token %}
                
                <h4 class="mb-4">版面設定</h4>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label">背景音樂</label>
                        <select class="form-select" name="background_music" id="background_music">
                            <option value="">請選擇禮儀音樂</option>
                            <option value="1">佛教音樂一</option>
                            <option value="2">佛教音樂二</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">背景樣式</label>
                        <select class="form-select mb-2" name="desktop_background" id="desktop_background" onchange="previewBackground('desktop')">
                            <option value="">請選擇桌電背景 (1280×3500)</option>
                            {% for i in "123" %}
                            <option value="{{ i }}">桌電背景 {{ i }}</option>
                            {% endfor %}
                        </select>
                        <select class="form-select" name="mobile_background" id="mobile_background" onchange="previewBackground('mobile')">
                            <option value="">請選擇手機背景 (600×3500)</option>
                            {% for i in "123" %}
                            <option value="{{ i }}">手機背景 {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">字體樣式</label>
                        <select class="form-select" name="font_style" id="font_style" onchange="previewFont()">
                            <option value="fangsong">華康仿宋體</option>
                            <option value="kaiti">標楷體</option>
                        </select>
                    </div>
                </div>

                <div class="preview-section mb-4">
                    <h5 class="mb-3">背景預覽 (1/5 比例)</h5>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="preview-box desktop-preview">
                                <h6>桌電版背景</h6>
                                <img id="preview_desktop" src="" alt="桌電背景預覽" style="display: none;">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="preview-box mobile-preview">
                                <h6>手機版背景</h6>
                                <img id="preview_mobile" src="" alt="手機背景預覽" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="form-group">
                    <label for="deceased_name" class="form-label">往生者全名</label>
                    <input type="text" class="form-control" id="deceased_name" name="deceased_name" required placeholder="如 某某某居士、某某某老太夫人">
                </div>

                <div class="form-group">
                    <label for="deceased_photo" class="form-label">個人照片</label>
                    <input type="file" class="form-control" id="deceased_photo" name="deceased_photo" accept="image/*" onchange="previewImage(this);">
                    <div class="form-text text-muted">
                        上傳直式相片，建議尺寸比例為 3:4
                        <br>
                        支援的格式：JPG、PNG
                    </div>
                    <div id="imagePreview" class="mt-2" style="display: none;">
                        <img id="preview" src="" alt="照片預覽" style="max-height: 200px; max-width: 150px; object-fit: contain;">
                        <button type="button" class="btn btn-sm btn-danger d-block mt-2" onclick="clearImage();">移除照片</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="birth_date" class="form-label">生年月日</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="hide_birth_date" name="hide_birth_date">
                                    <label class="form-check-label" for="hide_birth_date">
                                        不顯示
                                    </label>
                                </div>
                            </div>
                            <input type="date" class="form-control" id="birth_date" name="birth_date" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="death_date" class="form-label">辭世日期</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="hide_death_date" name="hide_death_date">
                                    <label class="form-check-label" for="hide_death_date">
                                        不顯示
                                    </label>
                                </div>
                            </div>
                            <input type="date" class="form-control" id="death_date" name="death_date" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ceremony_details" class="form-label">告別式說明</label>
                    <textarea class="form-control" id="ceremony_details" name="ceremony_details" rows="4" placeholder = "請輸入告別式說明"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">儀式流程</label>
                    <div id="ceremony_process_list" class="mb-3">
                        <!-- 動態添加的流程項目將在這裡 -->
                    </div>
                    <button type="button" class="btn btn-primary w-100" onclick="addCeremonyProcess()">新增儀式</button>
                </div>

                <div class="form-group">
                    <label class="form-label">訃聞圖片正面上傳</label>
                    <input type="file" class="form-control" id="obituary_front_image" name="obituary_front_image" accept="image/*" onchange="previewObituaryImage(this, 'front')">
                    <div class="form-text text-muted">
                        請上傳訃聞正面圖片，支援的格式：JPG、PNG
                    </div>
                    <div id="frontImagePreview" class="mt-2" style="display: none;">
                        <img id="frontPreview" src="" alt="正面圖片預覽" style="max-height: 200px; max-width: 150px; object-fit: contain;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">訃聞圖片反面上傳</label>
                    <input type="file" class="form-control" id="obituary_back_image" name="obituary_back_image" accept="image/*" onchange="previewObituaryImage(this, 'back')">
                    <div class="form-text text-muted">
                        請上傳訃聞反面圖片，支援的格式：JPG、PNG
                    </div>
                    <div id="backImagePreview" class="mt-2" style="display: none;">
                        <img id="backPreview" src="" alt="反面圖片預覽" style="max-height: 200px; max-width: 150px; object-fit: contain;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">位置資訊</label>
                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary" id="farewell_hall" onclick="switchLocationForm('farewell')">告別式會場</button>
                            <button type="button" class="btn btn-outline-primary" id="tomb" onclick="switchLocationForm('tomb')">靈堂</button>
                        </div>
                    </div>

                    <!-- 告別式會場表單 -->
                    <div id="farewell_form">
                        <div class="mb-3">
                            <label for="farewell_location_name" class="form-label">會場名稱</label>
                            <input type="text" class="form-control" id="farewell_location_name" name="farewell_location_name" placeholder="請輸入告別式會場名稱">
                        </div>

                        <div class="mb-3">
                            <label for="farewell_location_address" class="form-label">會場地址</label>
                            <input type="text" class="form-control" id="farewell_location_address" name="farewell_location_address" placeholder="請輸入會場地址">
                        </div>

                        <div class="mb-3">
                            <label for="farewell_location_area" class="form-label">所屬廳別</label>
                            <input type="text" class="form-control" id="farewell_location_area" name="farewell_location_area" placeholder="請輸入所屬廳別">
                        </div>

                        <div class="mb-3">
                            <label for="farewell_traffic_info" class="form-label">交通資訊</label>
                            <textarea class="form-control" id="farewell_traffic_info" name="farewell_traffic_info" rows="4" placeholder="請輸入細部交通資訊"></textarea>
                        </div>
                    </div>

                    <!-- 靈堂表單 -->
                    <div id="tomb_form" style="display: none;">
                        <div class="mb-3">
                            <label for="tomb_location_name" class="form-label">靈堂名稱</label>
                            <input type="text" class="form-control" id="tomb_location_name" name="tomb_location_name" placeholder="請輸入靈堂名稱">
                        </div>

                        <div class="mb-3">
                            <label for="tomb_location_address" class="form-label">靈堂地址</label>
                            <input type="text" class="form-control" id="tomb_location_address" name="tomb_location_address" placeholder="請輸入靈堂地址">
                        </div>

                        <div class="mb-3">
                            <label for="tomb_location_area" class="form-label">所屬廳別</label>
                            <input type="text" class="form-control" id="tomb_location_area" name="tomb_location_area" placeholder="請輸入所屬廳別">
                        </div>

                        <div class="mb-3">
                            <label for="tomb_traffic_info" class="form-label">交通資訊</label>
                            <textarea class="form-control" id="tomb_traffic_info" name="tomb_traffic_info" rows="4" placeholder="請輸入細部交通資訊"></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">致贈花禮</label>
                    <textarea class="form-control mb-3" id="flower_gift_description" name="flower_gift_description" rows="3" placeholder="請輸入致贈花禮的說明"></textarea>

                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary" id="send_farewell">送告別式</button>
                            <button type="button" class="btn btn-outline-primary" id="send_tomb">送靈堂</button>
                        </div>
                    </div>

                    <div class="row" id="flower_gift_list">
                        <!-- 動態添加的花禮項目將在這裡 -->
                    </div>
                    <button type="button" class="btn btn-primary w-100 mt-3" onclick="addFlowerGift()">新增花禮</button>
                </div>

                <div class="form-group">
                    <label class="form-label">回憶錄</label>
                    <input type="url" class="form-control" id="memorial_video" name="memorial_video" placeholder="請輸入 YouTube 網址">
                    <div class="form-text text-muted">
                        請輸入有效的 YouTube 網址
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">生活照</label>
                    <div class="row" id="life_photos_list">
                        <!-- 動態添加的生活照項目將在這裡 -->
                    </div>
                    <button type="button" class="btn btn-primary w-100 mt-3" onclick="addLifePhoto()">新增生活照</button>
                </div>

                <div class="form-group">
                    <label class="form-label">承辦人員</label>
                    <div class="mb-3">
                        <label for="agent_name" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="agent_name" name="agent_name" required placeholder="承辦人員姓名">
                    </div>
                    <div class="mb-3">
                        <label for="agent_phone" class="form-label">電話</label>
                        <input type="tel" class="form-control" id="agent_phone" name="agent_phone" required placeholder="承辦人員電話">
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="button" class="btn btn-info btn-submit me-2" onclick="previewObituary()">預覽</button>
                    <button type="submit" class="btn btn-primary btn-submit">製作訃聞</button>
                    <a href="{% url 'obituary_base' %}" class="btn btn-secondary ms-2">返回</a>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.querySelectorAll('input[name="music_option"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const fileInput = document.querySelector('input[type="file"]');
                fileInput.disabled = !document.getElementById('use_custom').checked;
            });
        });
        
        function previewImage(input) {
            const preview = document.getElementById('preview');
            const previewDiv = document.getElementById('imagePreview');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewDiv.style.display = 'block';
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function clearImage() {
            const input = document.getElementById('deceased_photo');
            const preview = document.getElementById('preview');
            const previewDiv = document.getElementById('imagePreview');
            
            input.value = '';
            preview.src = '';
            previewDiv.style.display = 'none';
        }
        
        document.getElementById('hide_birth_date').addEventListener('change', function() {
            const birthDate = document.getElementById('birth_date');
            birthDate.disabled = this.checked;
            if (this.checked) {
                birthDate.removeAttribute('required');
            } else {
                birthDate.setAttribute('required', '');
            }
        });

        document.getElementById('hide_death_date').addEventListener('change', function() {
            const deathDate = document.getElementById('death_date');
            deathDate.disabled = this.checked;
            if (this.checked) {
                deathDate.removeAttribute('required');
            } else {
                deathDate.setAttribute('required', '');
            }
        });

        // 半形轉全形標點符號對照表
        const punctuationMap = {
            ',': '，',
            '.': '。',
            '!': '！',
            '?': '？',
            ':': '：',
            ';': '；',
            '(': '（',
            ')': '）',
            '[': '［',
            ']': ']',
            '{': '｛',
            '}': '｝',
            '<': '＜',
            '>': '＞',
            '/': '／',
            '\\': '＼',
            '|': '｜',
            '"': '「',
            "'": '『',
            ' ': '　'
        };

        // 轉換函數
        function toFullWidth(text) {
            return text.replace(/[,\.!?:;\(\)\[\]{}<>\/\\|"' ]/g, char => punctuationMap[char] || char);
        }

        // 為所有文字輸入添加自動轉換
        document.querySelectorAll('input[type="text"], textarea').forEach(input => {
            input.addEventListener('blur', function() {
                this.value = toFullWidth(this.value);
            });
        });

        // 特別處理儀式流程的動態添加
        const originalAddCeremonyProcess = addCeremonyProcess;
        addCeremonyProcess = function() {
            originalAddCeremonyProcess();
            // 為新添加的輸入框添加轉換功能
            const newInputs = document.getElementById('ceremony_process_list').lastElementChild.querySelectorAll('input[type="text"]');
            newInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    this.value = toFullWidth(this.value);
                });
            });
        };

        // 位置資訊按鈕切換
        document.getElementById('farewell_hall').addEventListener('click', function() {
            this.classList.add('btn-primary');
            this.classList.remove('btn-outline-primary');
            document.getElementById('tomb').classList.remove('btn-primary');
            document.getElementById('tomb').classList.add('btn-outline-primary');
            document.getElementById('location_area_container').style.display = 'block';
        });

        document.getElementById('tomb').addEventListener('click', function() {
            this.classList.add('btn-primary');
            this.classList.remove('btn-outline-primary');
            document.getElementById('farewell_hall').classList.remove('btn-primary');
            document.getElementById('farewell_hall').classList.add('btn-outline-primary');
            document.getElementById('location_area_container').style.display = 'none';
            document.getElementById('location_area').value = '';
        });

        // 初始化地圖
        let map;
        let marker;
        let geocoder;
        let infoWindow;

        // 初始化地圖（設定在台灣中心點）
        function initMap() {
            const taiwan = { lat: 23.5, lng: 121.5 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: taiwan,
                zoom: 7
            });

            geocoder = new google.maps.Geocoder();
            infoWindow = new google.maps.InfoWindow();

            // 添加自動完成功能
            const input = document.getElementById('location_address');
            const autocomplete = new google.maps.places.Autocomplete(input);
            
            // 當選擇址時更新地圖
            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    return;
                }

                updateMap(place.geometry.location, place.formatted_address);
            });

            // 允許在地圖上點擊來設置位置
            map.addListener('click', function(e) {
                geocoder.geocode({
                    location: e.latLng
                }, function(results, status) {
                    if (status === 'OK') {
                        if (results[0]) {
                            document.getElementById('location_address').value = results[0].formatted_address;
                            updateMap(e.latLng, results[0].formatted_address);
                        }
                    }
                });
            });
        }

        // 搜尋位置
        function searchLocation() {
            const address = document.getElementById('location_address').value;
            
            geocoder.geocode({
                address: address
            }, function(results, status) {
                if (status === 'OK') {
                    updateMap(results[0].geometry.location, results[0].formatted_address);
                } else {
                    alert('找不到該地址，重新輸入');
                }
            });
        }

        // 更新地圖標記和資訊
        function updateMap(location, address) {
            map.setCenter(location);
            map.setZoom(16);

            // 更新或創建標記
            if (marker) {
                marker.setMap(null);
            }
            
            marker = new google.maps.Marker({
                map: map,
                position: location,
                animation: google.maps.Animation.DROP
            });

            // 更新資訊視窗
            infoWindow.setContent(address);
            infoWindow.open(map, marker);

            // 更新隱藏的經緯度輸入
            document.getElementById('latitude').value = location.lat();
            document.getElementById('longitude').value = location.lng();
        }

        // 頁面載入時初始化地圖
        window.addEventListener('load', initMap);

        // 字體預覽功能
        function previewFont() {
            const fontSelect = document.getElementById('font_style');
            const previewText = document.getElementById('preview_text');
            
            switch(fontSelect.value) {
                case 'kaiti':
                    previewText.style.fontFamily = '標楷體, KaiTi, 楷體-繁';
                    break;
                case 'fangsong':
                    previewText.style.fontFamily = '華康仿宋體, FangSong, 仿宋-繁';
                    break;
                default:
                    previewText.style.fontFamily = 'inherit';
            }
        }

        // 背景預覽功能
        function previewBackground(type) {
            const desktopSelect = document.getElementById('desktop_background');
            const mobileSelect = document.getElementById('mobile_background');
            const previewDesktop = document.getElementById('preview_desktop');
            const previewMobile = document.getElementById('preview_mobile');
            
            if (type === 'desktop' && desktopSelect.value) {
                const desktopPath = "{% static 'cloud_obituary/desktop/' %}" + desktopSelect.value + ".jpg";
                previewDesktop.src = desktopPath;
                previewDesktop.style.display = 'block';
                previewDesktop.parentElement.style.backgroundColor = 'white';
            }
            
            if (type === 'mobile' && mobileSelect.value) {
                const mobilePath = "{% static 'cloud_obituary/mobile/' %}" + mobileSelect.value + ".jpg";
                previewMobile.src = mobilePath;
                previewMobile.style.display = 'block';
                previewMobile.parentElement.style.backgroundColor = 'white';
            }
        }

        // 移除原有的背景置相關代碼
        function handleResize() {
            // 移除此函數的內容
        }

        // 移除視窗大小變化監聽
        // window.removeEventListener('resize', handleResize);

        // 移除 body 背景樣式設置
        document.body.style.backgroundColor = '#f8f9fa';  // 恢復原始背景色

        function addCeremonyProcess() {
            const container = document.getElementById('ceremony_process_list');
            const processItem = document.createElement('div');
            processItem.className = 'ceremony-item mb-2 p-3 bg-light rounded';
            
            // 創建時間和內容的容器
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'd-flex align-items-center gap-2';
            
            // 時間輸入
            const timeInput = document.createElement('input');
            timeInput.type = 'time';
            timeInput.className = 'form-control';
            timeInput.style.width = '120px';
            timeInput.name = 'ceremony_time[]';
            timeInput.required = true;
            
            // 內容輸入
            const contentInput = document.createElement('input');
            contentInput.type = 'text';
            contentInput.className = 'form-control';
            contentInput.name = 'ceremony_content[]';
            contentInput.required = true;
            contentInput.placeholder = '請輸入儀式內容';
            
            // 刪除按鈕
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-link text-danger p-0 ms-2';
            deleteBtn.innerHTML = '×';
            deleteBtn.style.fontSize = '24px';
            deleteBtn.style.textDecoration = 'none';
            deleteBtn.onclick = function() {
                container.removeChild(processItem);
            };
            
            // 組合元素
            contentWrapper.appendChild(timeInput);
            contentWrapper.appendChild(contentInput);
            contentWrapper.appendChild(deleteBtn);
            processItem.appendChild(contentWrapper);
            
            container.appendChild(processItem);
        }

        function previewObituaryImage(input, type) {
            const previewId = type === 'front' ? 'frontPreview' : 'backPreview';
            const previewDivId = type === 'front' ? 'frontImagePreview' : 'backImagePreview';
            const preview = document.getElementById(previewId);
            const previewDiv = document.getElementById(previewDivId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewDiv.style.display = 'block';
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addFlowerGift() {
            const container = document.getElementById('flower_gift_list');
            const index = container.children.length;
            const flowerItem = document.createElement('div');
            flowerItem.className = 'col-md-3 mb-4';

            const card = document.createElement('div');
            card.className = 'card';

            // 創建圖片預覽容器
            const imgPreviewContainer = document.createElement('div');
            imgPreviewContainer.className = 'img-preview-container';
            imgPreviewContainer.style.height = '200px';
            imgPreviewContainer.style.overflow = 'hidden';

            // 創建圖片預覽元素
            const imgPreview = document.createElement('img');
            imgPreview.className = 'card-img-top';
            imgPreview.style.display = 'none';
            imgPreview.style.height = '100%';
            imgPreview.style.width = '100%';
            imgPreview.style.objectFit = 'cover';

            // 修改文件輸入
            const imgInput = document.createElement('input');
            imgInput.type = 'file';
            imgInput.className = 'form-control';
            imgInput.name = `flower_gift_list[${index}][image]`;
            imgInput.accept = 'image/*';
            imgInput.onchange = function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imgPreview.src = e.target.result;
                        imgPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            };

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'form-control mb-2';
            nameInput.name = `flower_gift_list[${index}][name]`;
            nameInput.placeholder = '花禮名稱';

            const priceInput = document.createElement('input');
            priceInput.type = 'text';
            priceInput.className = 'form-control';
            priceInput.name = `flower_gift_list[${index}][price]`;
            priceInput.placeholder = '花禮價格';

            // 添加刪除按鈕
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-danger btn-sm position-absolute';
            deleteBtn.style.right = '5px';
            deleteBtn.style.top = '5px';
            deleteBtn.style.zIndex = '10';
            deleteBtn.innerHTML = '×';
            deleteBtn.onclick = function() {
                container.removeChild(flowerItem);
            };

            imgPreviewContainer.appendChild(imgPreview);
            cardBody.appendChild(nameInput);
            cardBody.appendChild(priceInput);

            card.appendChild(deleteBtn);
            card.appendChild(imgInput);
            card.appendChild(imgPreviewContainer);
            card.appendChild(cardBody);

            flowerItem.appendChild(card);
            container.appendChild(flowerItem);
        }

        // 置資訊按鈕切換
        document.getElementById('send_farewell').addEventListener('click', function() {
            this.classList.add('btn-primary');
            this.classList.remove('btn-outline-primary');
            document.getElementById('send_tomb').classList.remove('btn-primary');
            document.getElementById('send_tomb').classList.add('btn-outline-primary');
        });

        document.getElementById('send_tomb').addEventListener('click', function() {
            this.classList.add('btn-primary');
            this.classList.remove('btn-outline-primary');
            document.getElementById('send_farewell').classList.remove('btn-primary');
            document.getElementById('send_farewell').classList.add('btn-outline-primary');
        });

        function addLifePhoto() {
            const container = document.getElementById('life_photos_list');
            const index = container.children.length;
            const photoItem = document.createElement('div');
            photoItem.className = 'col-md-3 mb-4';

            const card = document.createElement('div');
            card.className = 'card position-relative';

            // 創建圖片預覽容器
            const imgPreviewContainer = document.createElement('div');
            imgPreviewContainer.className = 'img-preview-container';
            imgPreviewContainer.style.height = '200px';
            imgPreviewContainer.style.overflow = 'hidden';

            // 創建圖片預覽元素
            const imgPreview = document.createElement('img');
            imgPreview.className = 'card-img-top';
            imgPreview.style.display = 'none';
            imgPreview.style.height = '100%';
            imgPreview.style.width = '100%';
            imgPreview.style.objectFit = 'cover';

            // 添加刪除按鈕
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-danger btn-sm position-absolute';
            deleteBtn.style.right = '5px';
            deleteBtn.style.top = '5px';
            deleteBtn.style.zIndex = '10';
            deleteBtn.innerHTML = '×';
            deleteBtn.onclick = function() {
                container.removeChild(photoItem);
                updateLifePhotoIndexes();
            };

            const imgInput = document.createElement('input');
            imgInput.type = 'file';
            imgInput.className = 'form-control';
            imgInput.name = `life_photos[${index}]`;
            imgInput.accept = 'image/*';
            imgInput.onchange = function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imgPreview.src = e.target.result;
                        imgPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            };

            imgPreviewContainer.appendChild(imgPreview);
            card.appendChild(deleteBtn);
            card.appendChild(imgInput);
            card.appendChild(imgPreviewContainer);

            photoItem.appendChild(card);
            container.appendChild(photoItem);
        }

        // 添加更新索引的函數
        function updateLifePhotoIndexes() {
            const container = document.getElementById('life_photos_list');
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const input = items[i].querySelector('input[type="file"]');
                input.name = `life_photos[${i}]`;
            }
        }

        function previewLifePhoto(input, card) {
            const imgPreview = card.querySelector('.card-img-top');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    imgPreview.src = e.target.result;
                    imgPreview.style.display = 'block';
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewObituary() {
            const form = document.getElementById('obituaryForm');
            const formData = new FormData(form);
            
            const submitForm = document.createElement('form');
            submitForm.method = 'POST';
            submitForm.action = '/preview_obituary/';
            submitForm.enctype = 'multipart/form-data';
            submitForm.target = '_blank';
            
            // 添加 CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            submitForm.appendChild(csrfInput);
            
            // 將 FormData 中的數據轉換為表單元素
            for (let [key, value] of formData.entries()) {
                if (value instanceof File) {
                    // 檢查文件是否為空
                    if (value.size > 0) {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.name = key;
                        
                        // 創建一個新的 FileList 對象
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(value);
                        input.files = dataTransfer.files;
                        
                        submitForm.appendChild(input);
                        console.log(`添加文件: ${key}, size: ${value.size}`);
                    }
                } else {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    submitForm.appendChild(input);
                }
            }
            
            // 調試信息
            console.log('提交的表單數據:');
            const finalFormData = new FormData(submitForm);
            for (let [key, value] of finalFormData.entries()) {
                if (value instanceof File) {
                    console.log(`${key}: File (${value.size} bytes)`);
                } else {
                    console.log(`${key}: ${value}`);
                }
            }
            
            document.body.appendChild(submitForm);
            submitForm.submit();
            document.body.removeChild(submitForm);
        }

        // 添加切換表單的 JavaScript
        function switchLocationForm(type) {
            // 切換按鈕樣式
            if (type === 'farewell') {
                document.getElementById('farewell_hall').classList.add('btn-primary');
                document.getElementById('farewell_hall').classList.remove('btn-outline-primary');
                document.getElementById('tomb').classList.remove('btn-primary');
                document.getElementById('tomb').classList.add('btn-outline-primary');
            } else {
                document.getElementById('tomb').classList.add('btn-primary');
                document.getElementById('tomb').classList.remove('btn-outline-primary');
                document.getElementById('farewell_hall').classList.remove('btn-primary');
                document.getElementById('farewell_hall').classList.add('btn-outline-primary');
            }

            // 切換表單顯示
            document.getElementById('farewell_form').style.display = type === 'farewell' ? 'block' : 'none';
            document.getElementById('tomb_form').style.display = type === 'tomb' ? 'block' : 'none';
        }

        // 在表單提交前添加調試
        document.querySelector('form').addEventListener('submit', function(e) {
            // e.preventDefault(); // 測試時可以取消註釋來防止表單提交
            console.log('表單提交數據:');
            const formData = new FormData(this);
            for (let pair of formData.entries()) {
                console.log(pair[0], pair[1]);
            }
        });
    </script>
</body>
</html> 